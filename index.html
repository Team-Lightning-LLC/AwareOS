<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AwareOS - Command Center</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link rel="stylesheet" href="./src/shell/Shell.css">
    <style>
        #root {
            width: 100vw;
            height: 100vh;
        }
    </style>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel" data-type="module">
        const { useState, useEffect, useRef } = React;

        // ===== CORE =====
        
        // Event Bus
        class EventBus {
            constructor() {
                this.listeners = {};
            }
            on(event, callback) {
                if (!this.listeners[event]) this.listeners[event] = [];
                this.listeners[event].push(callback);
                return () => {
                    this.listeners[event] = this.listeners[event].filter(cb => cb !== callback);
                };
            }
            emit(event, data) {
                console.log(`[EventBus] ${event}`, data);
                if (this.listeners[event]) {
                    this.listeners[event].forEach(callback => callback(data));
                }
                if (this.listeners['*']) {
                    this.listeners['*'].forEach(callback => callback(event, data));
                }
            }
            once(event, callback) {
                const unsubscribe = this.on(event, (data) => {
                    callback(data);
                    unsubscribe();
                });
            }
        }

        const eventBus = new EventBus();

        // Registry
        class Registry {
            constructor() {
                this.apps = new Map();
            }
            register(app) {
                if (!app.manifest || !app.manifest.name) {
                    throw new Error('App must have a manifest with a name');
                }
                const name = app.manifest.name;
                console.log(`[Registry] Registering app: ${name}`);
                this.apps.set(name, app);
            }
            get(name) {
                return this.apps.get(name);
            }
            getAll() {
                return Array.from(this.apps.values());
            }
            getAllManifests() {
                return this.getAll().map(app => app.manifest);
            }
            getAllState() {
                const state = {};
                for (const [name, app] of this.apps) {
                    if (typeof app.getState === 'function') {
                        state[name] = app.getState();
                    }
                }
                return state;
            }
            dispatch(appName, action, params) {
                const app = this.apps.get(appName);
                if (!app) throw new Error(`App not found: ${appName}`);
                if (typeof app.dispatch !== 'function') {
                    throw new Error(`App ${appName} doesn't support actions`);
                }
                console.log(`[Registry] Dispatching to ${appName}:`, action, params);
                return app.dispatch(action, params);
            }
        }

        const registry = new Registry();

        // ===== CALENDAR APP =====
        
        // Calendar Manifest
        const calendarManifest = {
            name: 'calendar',
            domain: 'time-based commitments and availability',
            capabilities: ['read_events', 'check_availability', 'find_free_time'],
            actions: ['create_event', 'update_event', 'delete_event', 'get_events'],
            events: ['event_created', 'event_updated', 'event_deleted', 'event_moved']
        };

        // Calendar State
        class CalendarState {
            constructor() {
                this.events = [];
                this.loadFromStorage();
            }
            loadFromStorage() {
                try {
                    const saved = localStorage.getItem('awareos_calendar_events');
                    if (saved) {
                        this.events = JSON.parse(saved);
                        console.log(`[Calendar] Loaded ${this.events.length} events`);
                    }
                } catch (error) {
                    console.error('[Calendar] Failed to load events:', error);
                }
            }
            saveToStorage() {
                try {
                    localStorage.setItem('awareos_calendar_events', JSON.stringify(this.events));
                } catch (error) {
                    console.error('[Calendar] Failed to save events:', error);
                }
            }
            getAll() {
                return [...this.events];
            }
            getToday() {
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const tomorrow = new Date(today);
                tomorrow.setDate(tomorrow.getDate() + 1);
                return this.events.filter(event => {
                    const eventTime = new Date(event.start).getTime();
                    return eventTime >= today.getTime() && eventTime < tomorrow.getTime();
                });
            }
            add(event) {
                const newEvent = {
                    id: Date.now().toString(),
                    ...event,
                    createdAt: new Date().toISOString(),
                    status: event.status || 'confirmed'
                };
                this.events.push(newEvent);
                this.saveToStorage();
                return newEvent;
            }
            delete(id) {
                const index = this.events.findIndex(e => e.id === id);
                if (index === -1) throw new Error(`Event not found: ${id}`);
                const deleted = this.events.splice(index, 1)[0];
                this.saveToStorage();
                return deleted;
            }
            getSnapshot() {
                return {
                    eventsToday: this.getToday(),
                    totalEvents: this.events.length
                };
            }
        }

        const calendarState = new CalendarState();

        // Calendar Actions
        const calendarActions = {
            create_event(params) {
                const { title, start, end, location } = params;
                if (!title || !start) {
                    throw new Error('Event requires at least title and start time');
                }
                const eventEnd = end || new Date(new Date(start).getTime() + 60 * 60 * 1000).toISOString();
                const newEvent = calendarState.add({
                    title,
                    start,
                    end: eventEnd,
                    location
                });
                eventBus.emit('calendar_event_created', {
                    event: newEvent,
                    source: 'calendar'
                });
                return newEvent;
            },
            delete_event(params) {
                const { id } = params;
                if (!id) throw new Error('Event ID required for deletion');
                const deleted = calendarState.delete(id);
                eventBus.emit('calendar_event_deleted', {
                    event: deleted,
                    source: 'calendar'
                });
                return deleted;
            },
            get_events(params = {}) {
                return calendarState.getToday();
            }
        };

        // Calendar App
        const calendarApp = {
            manifest: calendarManifest,
            getState: () => calendarState.getSnapshot(),
            dispatch: (action, params) => {
                if (!calendarActions[action]) {
                    throw new Error(`Unknown action: ${action}`);
                }
                return calendarActions[action](params);
            },
            init: () => {
                console.log('[Calendar] Ready');
            }
        };

        // ===== UI COMPONENTS =====
        
        // Calendar Widget
        function CalendarWidget() {
            const [events, setEvents] = useState([]);
            const [showForm, setShowForm] = useState(false);
            const [formData, setFormData] = useState({
                title: '',
                date: '',
                startTime: '',
                endTime: '',
                location: ''
            });

            useEffect(() => {
                loadEvents();
                const unsubscribe = eventBus.on('*', (event) => {
                    if (event.startsWith('calendar_')) {
                        loadEvents();
                    }
                });
                return () => unsubscribe();
            }, []);

            const loadEvents = () => {
                try {
                    const todayEvents = registry.dispatch('calendar', 'get_events', {});
                    setEvents(todayEvents);
                } catch (error) {
                    console.error('[CalendarWidget] Failed to load events:', error);
                }
            };

            const handleSubmit = (e) => {
                e.preventDefault();
                const start = `${formData.date}T${formData.startTime}:00`;
                const end = `${formData.date}T${formData.endTime}:00`;
                try {
                    registry.dispatch('calendar', 'create_event', {
                        title: formData.title,
                        start,
                        end,
                        location: formData.location
                    });
                    setFormData({ title: '', date: '', startTime: '', endTime: '', location: '' });
                    setShowForm(false);
                } catch (error) {
                    alert('Failed to create event: ' + error.message);
                }
            };

            const handleDelete = (id) => {
                if (confirm('Delete this event?')) {
                    try {
                        registry.dispatch('calendar', 'delete_event', { id });
                    } catch (error) {
                        alert('Failed to delete event: ' + error.message);
                    }
                }
            };

            return (
                <div style={{ padding: '15px', fontSize: '13px' }}>
                    <button
                        onClick={() => setShowForm(!showForm)}
                        className="add-event-btn"
                        style={{
                            width: '100%',
                            padding: '10px',
                            background: '#4a9eff',
                            border: 'none',
                            borderRadius: '6px',
                            color: 'white',
                            cursor: 'pointer',
                            fontSize: '12px',
                            fontWeight: '500',
                            marginBottom: '15px'
                        }}
                    >
                        {showForm ? 'Cancel' : '+ Add Event'}
                    </button>

                    {showForm && (
                        <form onSubmit={handleSubmit} style={{ background: '#252540', padding: '15px', borderRadius: '6px', marginBottom: '15px' }}>
                            <div style={{ marginBottom: '12px' }}>
                                <label style={{ display: 'block', fontSize: '11px', color: '#aaa', marginBottom: '4px' }}>Title *</label>
                                <input
                                    required
                                    value={formData.title}
                                    onChange={(e) => setFormData({ ...formData, title: e.target.value })}
                                    style={{ width: '100%', padding: '8px', background: '#1a1a2e', border: '1px solid #444', borderRadius: '4px', color: '#eee', fontSize: '12px' }}
                                />
                            </div>
                            <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '10px' }}>
                                <div style={{ marginBottom: '12px' }}>
                                    <label style={{ display: 'block', fontSize: '11px', color: '#aaa', marginBottom: '4px' }}>Date *</label>
                                    <input
                                        type="date"
                                        required
                                        value={formData.date}
                                        onChange={(e) => setFormData({ ...formData, date: e.target.value })}
                                        style={{ width: '100%', padding: '8px', background: '#1a1a2e', border: '1px solid #444', borderRadius: '4px', color: '#eee', fontSize: '12px' }}
                                    />
                                </div>
                                <div style={{ marginBottom: '12px' }}>
                                    <label style={{ display: 'block', fontSize: '11px', color: '#aaa', marginBottom: '4px' }}>Location</label>
                                    <input
                                        value={formData.location}
                                        onChange={(e) => setFormData({ ...formData, location: e.target.value })}
                                        style={{ width: '100%', padding: '8px', background: '#1a1a2e', border: '1px solid #444', borderRadius: '4px', color: '#eee', fontSize: '12px' }}
                                    />
                                </div>
                            </div>
                            <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '10px' }}>
                                <div style={{ marginBottom: '12px' }}>
                                    <label style={{ display: 'block', fontSize: '11px', color: '#aaa', marginBottom: '4px' }}>Start *</label>
                                    <input
                                        type="time"
                                        required
                                        value={formData.startTime}
                                        onChange={(e) => setFormData({ ...formData, startTime: e.target.value })}
                                        style={{ width: '100%', padding: '8px', background: '#1a1a2e', border: '1px solid #444', borderRadius: '4px', color: '#eee', fontSize: '12px' }}
                                    />
                                </div>
                                <div style={{ marginBottom: '12px' }}>
                                    <label style={{ display: 'block', fontSize: '11px', color: '#aaa', marginBottom: '4px' }}>End *</label>
                                    <input
                                        type="time"
                                        required
                                        value={formData.endTime}
                                        onChange={(e) => setFormData({ ...formData, endTime: e.target.value })}
                                        style={{ width: '100%', padding: '8px', background: '#1a1a2e', border: '1px solid #444', borderRadius: '4px', color: '#eee', fontSize: '12px' }}
                                    />
                                </div>
                            </div>
                            <button type="submit" style={{ width: '100%', padding: '10px', background: '#10b981', border: 'none', borderRadius: '4px', color: 'white', cursor: 'pointer', fontSize: '12px', fontWeight: '500' }}>
                                Create Event
                            </button>
                        </form>
                    )}

                    <h4 style={{ fontSize: '12px', color: '#888', marginBottom: '10px' }}>Today's Events</h4>

                    {events.length === 0 ? (
                        <div style={{ padding: '40px 20px', textAlign: 'center', color: '#666', fontSize: '12px' }}>
                            No events today
                        </div>
                    ) : (
                        events.map(event => {
                            const start = new Date(event.start);
                            const end = new Date(event.end);
                            return (
                                <div key={event.id} style={{ background: '#252540', border: '1px solid #333', borderRadius: '6px', padding: '12px', marginBottom: '10px' }}>
                                    <div style={{ display: 'flex', justifyContent: 'space-between' }}>
                                        <div>
                                            <div style={{ fontWeight: '500', marginBottom: '4px' }}>{event.title}</div>
                                            <div style={{ fontSize: '11px', color: '#888' }}>
                                                {start.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' })}
                                                {' - '}
                                                {end.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' })}
                                            </div>
                                            {event.location && (
                                                <div style={{ fontSize: '11px', color: '#666', marginTop: '4px' }}>
                                                    üìç {event.location}
                                                </div>
                                            )}
                                        </div>
                                        <button onClick={() => handleDelete(event.id)} style={{ background: 'none', border: 'none', color: '#666', cursor: 'pointer', fontSize: '14px' }}>√ó</button>
                                    </div>
                                </div>
                            );
                        })
                    )}
                </div>
            );
        }

        // Notification Bar
        function NotificationBar({ suggestions }) {
            if (suggestions.length === 0) return null;
            return (
                <div style={{ position: 'fixed', top: 0, left: 0, right: 0, zIndex: 1000, padding: '10px 20px', background: 'rgba(26, 26, 46, 0.98)', borderBottom: '1px solid #333' }}>
                    <div style={{ background: '#252540', border: '1px solid #f59e0b', borderRadius: '6px', padding: '12px 15px', fontSize: '13px', color: '#eee' }}>
                        ü§ñ {suggestions[0].message}
                    </div>
                </div>
            );
        }

        // Widget Container
        function Widget({ widget, onMove, onResize, onRemove }) {
            const [isDragging, setIsDragging] = useState(false);
            const [dragOffset, setDragOffset] = useState({ x: 0, y: 0 });
            const widgetRef = useRef(null);

            useEffect(() => {
                if (!isDragging) return;
                const handleMouseMove = (e) => {
                    onMove(widget.id, e.clientX - dragOffset.x, e.clientY - dragOffset.y);
                };
                const handleMouseUp = () => setIsDragging(false);
                window.addEventListener('mousemove', handleMouseMove);
                window.addEventListener('mouseup', handleMouseUp);
                return () => {
                    window.removeEventListener('mousemove', handleMouseMove);
                    window.removeEventListener('mouseup', handleMouseUp);
                };
            }, [isDragging, dragOffset, widget.id, onMove]);

            return (
                <div ref={widgetRef} className="widget" style={{ left: widget.x, top: widget.y, width: widget.w, height: widget.h }}>
                    <div 
                        className="widget-header"
                        onMouseDown={(e) => {
                            const rect = widgetRef.current.getBoundingClientRect();
                            setDragOffset({ x: e.clientX - rect.left, y: e.clientY - rect.top });
                            setIsDragging(true);
                        }}
                    >
                        <span className="widget-title">üìÖ Calendar</span>
                        <div className="widget-controls">
                            <button className="widget-btn" onClick={() => onRemove(widget.id)}>√ó</button>
                        </div>
                    </div>
                    <div className="widget-content">
                        <CalendarWidget />
                    </div>
                </div>
            );
        }

        // Main Shell
        function Shell() {
            const [widgets, setWidgets] = useState([
                { id: 'calendar-1', type: 'calendar', x: 100, y: 50, w: 400, h: 500 }
            ]);
            const [suggestions, setSuggestions] = useState([]);

            useEffect(() => {
                const unsubscribe = eventBus.on('orchestrator_suggestion', (data) => {
                    setSuggestions(prev => [data, ...prev].slice(0, 5));
                });
                return () => unsubscribe();
            }, []);

            const moveWidget = (id, x, y) => {
                setWidgets(ws => ws.map(w => w.id === id ? { ...w, x, y } : w));
            };

            const removeWidget = (id) => {
                setWidgets(ws => ws.filter(w => w.id !== id));
            };

            return (
                <div className="shell">
                    <NotificationBar suggestions={suggestions} />
                    <div className="canvas">
                        {widgets.map(widget => (
                            <Widget
                                key={widget.id}
                                widget={widget}
                                onMove={moveWidget}
                                onRemove={removeWidget}
                            />
                        ))}
                    </div>
                </div>
            );
        }

        // ===== INITIALIZE =====
        
        async function init() {
            console.log('[AwareOS] Initializing...');
            
            // Register apps
            registry.register(calendarApp);
            console.log('[AwareOS] ‚úì Calendar registered');
            
            // Initialize apps
            calendarApp.init();
            
            // Expose to window
            window.AwareOS = {
                eventBus,
                registry,
                calendarState
            };
            
            // Mount UI
            const root = ReactDOM.createRoot(document.getElementById('root'));
            root.render(<Shell />);
            
            console.log('[AwareOS] Ready! üß†');
            console.log('[AwareOS] Try: AwareOS.registry.dispatch("calendar", "create_event", { title: "Test", start: new Date().toISOString() })');
        }

        init();
    </script>
</body>
</html>
